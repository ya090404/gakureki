<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ノベル＋クイズゲーム</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: black;
    }
    #inputContainer {
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }
    #answerInput {
      font-size: 20px;
      padding: 8px;
      width: 250px;
      border-radius: 6px;
      border: none;
      text-align: center;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="750" height="1334"></canvas>
  <div id="inputContainer">
    <input id="answerInput" type="text" placeholder="ひらがなで入力してね" />
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const images = {};
    const imageFiles = {
      boy: "boy.PNG",
      girl: "girl.PNG"
    };

    let currentScene = 0;
    let answerInput = document.getElementById("answerInput");
    let inputContainer = document.getElementById("inputContainer");
    let score = 0;

    const scenes = [
      { type: "image", image: "boy", text: "実は…その…伝えたいことがあって！" },
      { type: "image", image: "girl", text: "えっ、なに？" },
      { type: "image", image: "boy", text: "ずっと…好きでした！俺と、付き合ってください！" },
      { type: "image", image: "girl", text: "ありがとう。嬉しいよ。付き合いたい気持ちはあるけど…" },
      { type: "image", image: "girl", text: "私、誰かと付き合う前に、テストをするって決めてるの。" },
      { type: "image", image: "boy", text: "テ………テスト！？" },
      { type: "image", image: "girl", text: "今から、始めるね。全問正解したら、付き合ってもいいよ。" },
      { type: "quiz1" },
      { type: "quiz2" },
    ];

    function preloadImages(callback) {
      let loaded = 0;
      const keys = Object.keys(imageFiles);
      keys.forEach(key => {
        images[key] = new Image();
        images[key].src = imageFiles[key];
        images[key].onload = () => {
          loaded++;
          if (loaded === keys.length) callback();
        };
      });
    }

    function drawScene() {
      const scene = scenes[currentScene];
      if (scene.type === "image") {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(images[scene.image], 0, 0, canvas.width, canvas.height);

        // 名前枠
        ctx.font = "bold 28px sans-serif";
        ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        ctx.strokeText("西条さん", 60, 1040);
        ctx.fillText("西条さん", 60, 1040);

        // セリフ本文
        ctx.font = "bold 30px sans-serif";
        wrapText(scene.text, 60, 1090, 630, 36);
      }

      if (scene.type === "quiz1") showQuiz1();
      if (scene.type === "quiz2") showQuiz2();
    }

    function wrapText(text, x, y, maxWidth, lineHeight) {
      const words = text.split("");
      let line = "";
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n];
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
          ctx.strokeText(line, x, y);
          ctx.fillText(line, x, y);
          line = words[n];
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.strokeText(line, x, y);
      ctx.fillText(line, x, y);
    }

    function showQuiz1() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(images["girl"], 0, 0, canvas.width, canvas.height);
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "white";
      ctx.strokeStyle = "black";
      ctx.lineWidth = 4;
      ctx.strokeText("西条さん", 60, 1040);
      ctx.fillText("西条さん", 60, 1040);
      ctx.font = "bold 30px sans-serif";
      wrapText("日本地図:この県はどこ？", 60, 1090, 630, 36);

      const map = new Image();
      map.src = "DB64439C-EB4A-4CEF-BB0D-C257E659D889.png";
      map.onload = () => {
        ctx.drawImage(map, 200, 600, 350, 200);
      };

      createQuizButtons(["徳島県", "香川県", "愛媛県", "高知県"], "高知県", () => {
        currentScene++;
        drawScene();
      });
    }

    function showQuiz2() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(images["girl"], 0, 0, canvas.width, canvas.height);
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "white";
      ctx.strokeStyle = "black";
      ctx.lineWidth = 4;
      ctx.strokeText("西条さん", 60, 1040);
      ctx.fillText("西条さん", 60, 1040);
      ctx.font = "bold 30px sans-serif";
      wrapText("第二問:『？？』をひらがなで埋めてね。「？？、竹取の翁といふものありけり。野山にまじりて、竹をとりつゝ、よろづの事につかひけり。」（『竹取物語』）", 60, 1090, 630, 36);

      inputContainer.style.display = "block";
      answerInput.value = "";
      answerInput.focus();

      answerInput.onkeypress = function (e) {
        if (e.key === "Enter") {
          const ans = answerInput.value.trim();
          if (ans === "いまはむかし") score++;
          inputContainer.style.display = "none";
          currentScene++;
          drawScene(); // ←次の問題（3問目）へ
        }
      };
    }

    function createQuizButtons(options, correct, callback) {
      const existing = document.querySelectorAll(".quiz-btn");
      existing.forEach(btn => btn.remove());

      options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "quiz-btn";
        btn.textContent = opt;
        btn.style.position = "absolute";
        btn.style.left = (idx % 2 === 0 ? "100px" : "400px");
        btn.style.top = (idx < 2 ? "950px" : "1050px");
        btn.style.width = "200px";
        btn.style.height = "60px";
        btn.style.background = "pink";
        btn.style.fontSize = "20px";
        btn.style.border = "none";
        btn.style.borderRadius = "10px";
        btn.style.zIndex = 10;

        btn.onclick = () => {
          if (opt === correct) score++;
          callback();
        };

        document.body.appendChild(btn);
      });
    }

    canvas.addEventListener("click", () => {
      const scene = scenes[currentScene];
      if (scene.type === "image") {
        currentScene++;
        drawScene();
      }
    });

    preloadImages(drawScene);
  </script>
</body>
</html>